version: 0.2
env:
  shell: bash
phases:
  pre_build:
    commands:
      # Login to ECR
      - echo Logging in to ECR...
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      - echo Configuring the EKS Cluster authentication...
      - aws configure set region $AWS_DEFAULT_REGION
      - SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id $KUBE_SECRET_NAME --query 'SecretString' --output text)
      - echo "$SECRET_JSON" > kubeconfig.yaml
      - chmod 644 kubeconfig.yaml
      - export KUBECONFIG=$CODEBUILD_SRC_DIR/kubeconfig.yaml
      - aws eks --region us-east-1 update-kubeconfig --name comm-cluster
      # Generate Docker Images Tags
      - RANDOMSTR=$(openssl rand -base64 6 | tr -dc 'a-z0-9' | head -c 10)
      - GRPC_TAG=$(echo "grpc-$RANDOMSTR")
      - echo $GRPC_ECR_TAG
      - WEB_TAG=$(echo "web-$RANDOMSTR")
      - echo $WEB_TAG
      - ECR_REPO_URL=$(echo "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME")
      - GRPC_ECR_TAG=$(echo "$ECR_REPO_URL:$GRPC_TAG")
      - WEB_ECR_TAG=$(echo "$ECR_REPO_URL:$WEB_TAG")
      - echo $GRPC_ECR_TAG
      - echo $WEB_ECR_TAG
      - ls -l kubernetes/*
      - sed -i "s|'replacehere'|${WEB_ECR_TAG}|g" kubernetes/webserver-deployment.yml
      - cat  kubernetes/webserver-deployment.yml

  build:
    commands:
      - echo Build started on `date`
      - echo Building the grpcserver Docker image...
      - docker build app/grpcserver/. -t $GRPC_TAG
      - docker tag $GRPC_TAG:latest $GRPC_ECR_TAG     
      - echo Building the webserver Docker image...
      - docker build app/webserver/. -t $WEB_TAG
      - docker tag $WEB_TAG:latest $WEB_ECR_TAG     
      - echo Build completed on `date`
      - docker images

  post_build:
    commands:
      - echo "Pushing the grpc-server Docker image to ECR Repo $IMAGE_REPO_NAME"
      - docker push $GRPC_ECR_TAG
      - echo "Pushing the  web-server Docker image to ECR Repo $IMAGE_REPO_NAME"
      - docker push $WEB_ECR_TAG
      - echo Applying Kubernetes manifests...           
      - cd kubernetes
      - sed -i "s|\GRPC-TAG-PLACEHOLDER|$GRPC_ECR_TAG|g" grpcserver-deployment.yml
      - echo $WEB_ECR_TAG
      - kubectl apply -f .
      - echo Post_Build completed on `date`